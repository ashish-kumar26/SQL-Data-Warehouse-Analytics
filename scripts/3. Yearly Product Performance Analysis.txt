/*
3. Yearly Product Performance Analysis
Purpose:
  Evaluate product performance on a yearly basis and compare trends.

Key Features:
  ● Year-wise product sales
  ● Comparison with product’s average historical sales
  ● Identification of above/below average performance
  ● Year-over-Year (YoY) sales growth or decline
*/

WITH yearly_product_sales AS (
    SELECT 
        EXTRACT(YEAR FROM f.order_date) AS order_year,
        p.product_name,
        SUM(f.sales_amount) AS current_sales
    FROM gold.fact_sales f
    LEFT JOIN gold.dim_products p
        ON f.product_key = p.product_key
    WHERE f.order_date IS NOT NULL
    GROUP BY 
        EXTRACT(YEAR FROM f.order_date),
        p.product_name
)
SELECT 
    order_year,
    product_name,
    current_sales,
    ROUND(AVG(current_sales) OVER (PARTITION BY product_name),0) AS avg_sales_per_product,
	current_sales - ROUND(AVG(current_sales) OVER (PARTITION BY product_name),0) AS diff_from_avg_sales,
	CASE WHEN current_sales - ROUND(AVG(current_sales) OVER (PARTITION BY product_name),0) > 0 THEN 'Above Average'
	     WHEN current_sales - ROUND(AVG(current_sales) OVER (PARTITION BY product_name),0) < 0 THEN 'Below Average'
		 ELSE 'Average'
	END avg_change,
-- YEAR OVER YEAR ANALYSIS
LAG(current_sales) OVER(PARTITION BY product_name ORDER BY order_year) previous_year_sales,
current_sales - LAG(current_sales) OVER(PARTITION BY product_name ORDER BY order_year) AS diff_previous_year_sales,
CASE WHEN current_sales - LAG(current_sales) OVER(PARTITION BY product_name ORDER BY order_year) > 0 THEN 'Increase'
	 WHEN current_sales - LAG(current_sales) OVER(PARTITION BY product_name ORDER BY order_year) < 0 THEN 'Decrease'
	 ELSE 'Average'
END previous_year_change
FROM yearly_product_sales
ORDER BY product_name, order_year;